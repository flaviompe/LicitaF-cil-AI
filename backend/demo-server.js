const express = require('express');
const cors = require('cors');
const fs = require('fs');
const path = require('path');

const app = express();
const PORT = 3001;

// Middleware
app.use(cors());
app.use(express.json());

// Carregar dados demo
const users = JSON.parse(fs.readFileSync(path.join(__dirname, 'data/demo-users.json'), 'utf8'));
const opportunities = JSON.parse(fs.readFileSync(path.join(__dirname, 'data/demo-opportunities.json'), 'utf8'));
const queries = JSON.parse(fs.readFileSync(path.join(__dirname, 'data/demo-queries.json'), 'utf8'));

// Sistema de categoriza√ß√£o e roteamento inteligente aprimorado
const categoryClassifier = {
  juridico: {
    keywords: ['prazo', 'recurso', 'lei', 'artigo', 'decreto', 'penalidade', 'san√ß√£o', 'suspenso', 'impugna√ß√£o', 'habilita√ß√£o', 'documentos', 'certid√£o', 'cnd', 'jur√≠dico', 'advogado', 'legal', 'inexigibilidade', 'dispensa', 'licita√ß√£o', 'contrato', 'me', 'epp', 'mei', 'microempresa', 'empate', 'ficto', 'devido', 'habilita√ß√£o', 'inabilita√ß√£o', 'conformidade', 'edital', 'clausula'],
    priority: 1,
    fallbackScore: 0.7
  },
  tecnico: {
    keywords: ['cadastro', 'plataforma', 'sistema', 'proposta', 'envio', 'upload', 'site', 'portal', 'comprasnet', 'sicaf', 'cnpj', 'senha', 'login', 'acesso', 'certificado', 'digital', 'erro', 'bug', 'instala√ß√£o', 'configura√ß√£o', 'navegador'],
    priority: 2,
    fallbackScore: 0.6
  },
  financeiro: {
    keywords: ['pagamento', 'nota', 'fiscal', 'faturamento', 'imposto', 'tributo', 'icms', 'pis', 'cofins', 'desconto', 'valor', 'pre√ßo', 'cota√ß√£o', 'or√ßamento', 'custo', 'margem', 'lucro', 'bdi', 'reajuste', '√≠ndice'],
    priority: 3,
    fallbackScore: 0.6
  },
  operacional: {
    keywords: ['etapa', 'cronograma', 'prazo', 'fase', 'procedimento', 'quando', 'como', 'onde', 'processo', 'andamento', 'status', 'situa√ß√£o', 'acompanhar', 'fluxo', 'execu√ß√£o', 'entrega'],
    priority: 4,
    fallbackScore: 0.5
  },
  estrategico: {
    keywords: ['vencer', 'ganhar', 'estrat√©gia', 'dica', 'performance', 'competir', 'melhorar', 'resultado', 'sucesso', 'experi√™ncia', 'hist√≥rico', 'networking', 'relacionamento', 'diferencial'],
    priority: 5,
    fallbackScore: 0.5
  }
};

// M√≥dulos especializados - simula√ß√£o para demo
const modules = {
  juridico: {
    processQuery: function(queryText, context = {}) {
      // N√£o chamar generateLegalResponse para evitar loop infinito
      return processDirectLegalQuery(queryText, context);
    }
  },
  tecnico: {
    processQuery: function(queryText, context = {}) {
      const query = queryText.toLowerCase();
      
      // Respostas espec√≠ficas para problemas t√©cnicos comuns
      if (query.includes('erro') || query.includes('bug') || query.includes('problema')) {
        return {
          response: "üîß **Resolu√ß√£o de Problemas T√©cnicos**\n\nVamos resolver isso! Para problemas t√©cnicos:\n\n**üìã Checklist R√°pido:**\n‚Ä¢ Limpe cache do navegador (Ctrl+F5)\n‚Ä¢ Verifique se certificado digital est√° v√°lido\n‚Ä¢ Teste em navegador diferente (Chrome/Edge)\n‚Ä¢ Desative bloqueador de pop-ups\n\n**üÜò Se persistir, me informe:**\n‚Ä¢ Qual navegador est√° usando?\n‚Ä¢ Mensagem de erro exata\n‚Ä¢ Em qual etapa trava?\n\nüí° **Dica**: 90% dos problemas se resolvem atualizando o navegador e verificando certificados!",
          confidence: 0.95,
          module: 'tecnico',
          category: 'troubleshooting'
        };
      }
      
      if (query.includes('certificado') || query.includes('token')) {
        return {
          response: "üîê **Certificado Digital - Guia Completo**\n\n**üì± Instala√ß√£o:**\n‚Ä¢ Baixe apenas do site oficial (Serpro, AC Certisign, etc.)\n‚Ä¢ Execute como administrador\n‚Ä¢ Reinicie navegador ap√≥s instalar\n\n**‚ö° Resolu√ß√£o de Problemas:**\n‚Ä¢ Certificado n√£o aparece? Verifique se est√° no navegador correto\n‚Ä¢ Expirado? Renove com 30 dias de anteced√™ncia\n‚Ä¢ Erro \"certificado inv√°lido\"? Sincronize data/hora do computador\n\n**üéØ Plataformas que aceitam:**\n‚Ä¢ ComprasNet - A1 e A3\n‚Ä¢ BEC-SP - A1 e A3  \n‚Ä¢ Licita√ß√µes-e - A1 e A3\n\nüí° **Dica Pro**: Sempre tenha backup do certificado em pen drive!",
          confidence: 0.98,
          module: 'tecnico',
          category: 'certificacao'
        };
      }
      
      if (query.includes('comprasnet') || query.includes('portal')) {
        return {
          response: "üåê **ComprasNet - Guia de Uso**\n\n**üöÄ Acesso R√°pido:**\n‚Ä¢ URL: www.comprasnet.gov.br\n‚Ä¢ Login: CNPJ + senha\n‚Ä¢ Certificado: Obrigat√≥rio para propostas\n\n**üìã Passo a passo para participar:**\n1. Fa√ßa cadastro no SICAF\n2. Consulte oportunidades em \"Preg√µes\"\n3. Baixe edital e anexos\n4. Envie proposta at√© prazo limite\n5. Acompanhe sess√£o p√∫blica online\n\n**‚ö†Ô∏è Aten√ß√£o:**\n‚Ä¢ Propostas s√≥ at√© o hor√°rio limite\n‚Ä¢ Use sempre certificado v√°lido\n‚Ä¢ Mantenha dados SICAF atualizados\n\nüí° **Dica**: Teste seu acesso ANTES do dia da sess√£o!",
          confidence: 0.97,
          module: 'tecnico',
          category: 'plataforma'
        };
      }
      
      // Resposta padr√£o mais espec√≠fica
      return {
        response: `üíª **Suporte T√©cnico Personalizado**\n\nAnalisando: "${queryText}"\n\nüîß **√Åreas de especialidade:**\n‚Ä¢ **Plataformas governamentais** - ComprasNet, BEC, Licita√ß√µes-e\n‚Ä¢ **Certifica√ß√£o digital** - instala√ß√£o, renova√ß√£o, problemas\n‚Ä¢ **Navegadores** - configura√ß√£o, compatibilidade\n‚Ä¢ **Propostas eletr√¥nicas** - envio, formatos, erros\n‚Ä¢ **SICAF** - cadastro, atualiza√ß√£o, regularidade\n\n**üí° Para ajuda espec√≠fica, me diga:**\n‚Ä¢ Qual plataforma est√° usando?\n‚Ä¢ Qual erro ou dificuldade encontrou?\n‚Ä¢ Em que etapa do processo est√°?\n\nüöÄ **Resposta garantida em menos de 2 minutos!**`,
        confidence: 0.85,
        module: 'tecnico',
        category: 'suporte'
      };
    }
  },
  financeiro: {
    processQuery: function(queryText, context = {}) {
      const query = queryText.toLowerCase();
      
      if (query.includes('pagamento') || query.includes('receber') || query.includes('prazo')) {
        return {
          response: "üí∞ **Prazos de Pagamento - Guia Completo**\n\n**üìÖ Prazos Legais:**\n‚Ä¢ **At√© R$ 17.600**: 5 dias √∫teis (Lei 14.133/2021)\n‚Ä¢ **Acima R$ 17.600**: 30 dias corridos m√°ximo\n‚Ä¢ **Pequenas compras**: At√© 5 dias √∫teis\n\n**‚ö° Como acelerar recebimento:**\n‚Ä¢ Entregue nota fiscal completa e correta\n‚Ä¢ Anexe todos os documentos exigidos\n‚Ä¢ Confirme entrega por email/protocolo\n‚Ä¢ Monitore processo no sistema\n\n**üö® Se atrasar:**\n‚Ä¢ Direito a juros de 0,5% ao m√™s\n‚Ä¢ Corre√ß√£o monet√°ria pelo IPCA\n‚Ä¢ Cobran√ßa administrativa\n\nüí° **Dica**: Configure alertas para acompanhar pagamentos!",
          confidence: 0.96,
          module: 'financeiro',
          category: 'pagamento'
        };
      }
      
      if (query.includes('pre√ßo') || query.includes('valor') || query.includes('or√ßamento')) {
        return {
          response: "üìä **Forma√ß√£o de Pre√ßos Estrat√©gica**\n\n**üéØ Metodologia Vencedora:**\n‚Ä¢ Custo direto + indireto + impostos + margem\n‚Ä¢ BDI entre 15-25% (conforme complexidade)\n‚Ä¢ Pesquise pre√ßos de refer√™ncia (SINAPI, SICRO)\n‚Ä¢ Analise hist√≥rico do √≥rg√£o\n\n**üí° Estrat√©gias de competitividade:**\n‚Ä¢ ME/EPP: Use margem de empate de at√© 10%\n‚Ä¢ Volume: Negocie desconto progressivo\n‚Ä¢ Prazo: Ofere√ßa condi√ß√µes diferenciadas\n‚Ä¢ Qualidade: Destaque diferenciais t√©cnicos\n\n**üìà Ferramentas essenciais:**\n‚Ä¢ Planilha de custos detalhada\n‚Ä¢ √çndices oficiais atualizados\n‚Ä¢ An√°lise da concorr√™ncia\n‚Ä¢ Simula√ß√£o de cen√°rios\n\nüèÜ **Meta**: Ser competitivo mantendo margem saud√°vel de 8-15%!",
          confidence: 0.94,
          module: 'financeiro',
          category: 'precificacao'
        };
      }
      
      return {
        response: `üí∞ **Consultoria Financeira Personalizada**\n\nAnalisando: "${queryText}"\n\nüìä **Especialidades financeiras:**\n‚Ä¢ **Gest√£o de custos** - planilhas, BDI, margem\n‚Ä¢ **Fluxo de caixa** - recebimentos, pagamentos, capital de giro\n‚Ä¢ **Impostos** - SIMPLES, Lucro Real, benef√≠cios ME/EPP\n‚Ä¢ **Precifica√ß√£o** - estrat√©gias para vencer com margem\n‚Ä¢ **Contratos** - reajustes, aditivos, glosas\n\n**üí° Para an√°lise personalizada:**\n‚Ä¢ Qual seu faturamento m√©dio mensal?\n‚Ä¢ Margem atual dos seus contratos?\n‚Ä¢ Principal desafio financeiro?\n\nüìà **Objetivo**: Aumentar lucratividade em 20-30%!`,
        confidence: 0.85,
        module: 'financeiro',
        category: 'consultoria'
      };
    }
  },
  operacional: {
    processQuery: function(queryText, context = {}) {
      const query = queryText.toLowerCase();
      
      if (query.includes('cronograma') || query.includes('prazo') || query.includes('etapa')) {
        return {
          response: "üìÖ **Gest√£o de Cronogramas - M√©todo Eficaz**\n\n**‚è∞ Linha do Tempo T√≠pica:**\n‚Ä¢ **Publica√ß√£o**: Acompanhe diariamente\n‚Ä¢ **Esclarecimentos**: At√© 3 dias antes da abertura\n‚Ä¢ **Proposta**: Envie com 24h de anteced√™ncia\n‚Ä¢ **Habilita√ß√£o**: Documentos sempre atualizados\n‚Ä¢ **Execu√ß√£o**: Cronograma f√≠sico-financeiro\n\n**üéØ Sistema de Controle:**\n‚Ä¢ Planilha com alertas autom√°ticos\n‚Ä¢ Calend√°rio compartilhado da equipe\n‚Ä¢ Backup de documentos na nuvem\n‚Ä¢ Checklist de cada fase\n\n**üìã M√©tricas importantes:**\n‚Ä¢ Taxa de participa√ß√£o: +80%\n‚Ä¢ Aprova√ß√£o de propostas: +60%\n‚Ä¢ Pontualidade nas entregas: 100%\n\nüí° **Segredo**: Antecipa√ß√£o √© a chave do sucesso!",
          confidence: 0.95,
          module: 'operacional',
          category: 'cronograma'
        };
      }
      
      return {
        response: `‚öôÔ∏è **Opera√ß√µes Otimizadas**\n\nFoco na sua necessidade: "${queryText}"\n\nüìã **Processos que posso otimizar:**\n‚Ä¢ **Fluxo de propostas** - da oportunidade √† entrega\n‚Ä¢ **Gest√£o documental** - organiza√ß√£o, controle, backup\n‚Ä¢ **Acompanhamento** - status, prazos, alertas\n‚Ä¢ **Equipe** - divis√£o de tarefas, responsabilidades\n‚Ä¢ **Qualidade** - padroniza√ß√£o, checklists\n\n**üí° Para estruturar seu processo:**\n‚Ä¢ Quantas licita√ß√µes monitora mensalmente?\n‚Ä¢ Qual sua taxa de sucesso atual?\n‚Ä¢ Onde sente mais dificuldade operacional?\n\nüöÄ **Meta**: Aumentar efici√™ncia em 50% com menos esfor√ßo!`,
        confidence: 0.85,
        module: 'operacional',
        category: 'gestao'
      };
    }
  },
  estrategico: {
    processQuery: function(queryText, context = {}) {
      const query = queryText.toLowerCase();
      
      if (query.includes('vencer') || query.includes('ganhar') || query.includes('primeira')) {
        return {
          response: "üèÜ **Estrat√©gia para Vencer - Guia Definitivo**\n\n**üéØ Os 7 Pilares do Sucesso:**\n1. **Escolha certa**: Foque no seu nicho de expertise\n2. **Pre√ßo competitivo**: Use margem de empate ME/EPP\n3. **Proposta t√©cnica**: Destaque diferenciais √∫nicos\n4. **Documenta√ß√£o**: 100% conforme edital\n5. **Relacionamento**: Networking √©tico e profissional\n6. **Timing**: Participe no momento certo da empresa\n7. **Persist√™ncia**: Cada \"n√£o\" aproxima do \"sim\"\n\n**üìä Estat√≠sticas de sucesso:**\n‚Ä¢ Empresas focadas vencem 3x mais\n‚Ä¢ Pre√ßo corresponde a 70% da decis√£o\n‚Ä¢ Relacionamento influencia 25% dos casos\n\n**üí° Primeira licita√ß√£o:**\n‚Ä¢ Comece com valores menores (at√© R$ 80 mil)\n‚Ä¢ Escolha modalidade que domina\n‚Ä¢ Tenha capital de giro para 60 dias\n\nüéØ **Pr√≥ximo passo**: Defina seu nicho e metas!",
          confidence: 0.98,
          module: 'estrategico',
          category: 'sucesso'
        };
      }
      
      return {
        response: `üéØ **Estrat√©gia Personalizada**\n\nAnalisando seu objetivo: "${queryText}"\n\nüèÜ **√Åreas estrat√©gicas:**\n‚Ä¢ **Posicionamento** - nicho, diferencia√ß√£o, proposta de valor\n‚Ä¢ **Competitividade** - an√°lise concorrencial, vantagens\n‚Ä¢ **Crescimento** - expans√£o, novos mercados, parcerias\n‚Ä¢ **Performance** - m√©tricas, melhoria cont√≠nua\n‚Ä¢ **Networking** - relacionamentos estrat√©gicos √©ticos\n\n**üí° Para estrat√©gia sob medida:**\n‚Ä¢ H√° quanto tempo atua com licita√ß√µes?\n‚Ä¢ Qual seu principal objetivo (crescer, estabilizar, diversificar)?\n‚Ä¢ Que tipo de oportunidade mais te interessa?\n\nüöÄ **Resultado**: Estrat√©gia clara para alcan√ßar seus objetivos!`,
        confidence: 0.85,
        module: 'estrategico',
        category: 'estrategia'
      };
    }
  }
};

// Base de conhecimento jur√≠dico
const legalKnowledgeBase = {
  prazos: {
    keywords: ['prazo', 'deadline', 'tempo', 'recurso', 'impugna√ß√£o', 'esclarecimento'],
    responses: [
      {
        keywords: ['recurso', 'preg√£o'],
        response: "üìã **PRAZOS PARA RECURSOS NO PREG√ÉO ELETR√îNICO:**\n\nüïê **3 dias √∫teis** para interposi√ß√£o de recurso ap√≥s a sess√£o p√∫blica (art. 44, Lei 10.520/2002)\n\nüìÖ **Contagem**: A partir da intima√ß√£o do ato ou lavratura da ata\n\n‚öñÔ∏è **Base Legal**: Lei 10.520/2002, art. 44 c/c Decreto 10.024/2019\n\nüí° **Dica importante**: No preg√£o eletr√¥nico, o recurso deve ser manifestado imediatamente ap√≥s a sess√£o, e as raz√µes apresentadas em at√© 3 dias √∫teis.",
        confidence: 0.98,
        references: [
          { law: "Lei 10.520/2002", article: "Art. 44", relevance: 0.95 },
          { law: "Decreto 10.024/2019", article: "Art. 40", relevance: 0.90 }
        ]
      },
      {
        keywords: ['impugna√ß√£o', 'edital'],
        response: "üìã **PRAZOS PARA IMPUGNA√á√ÉO DE EDITAL:**\n\nüïê **At√© 3 dias √∫teis** antes da data fixada para abertura das propostas (art. 78, Lei 14.133/2021)\n\nüìß **Como fazer**: Peti√ß√£o dirigida √† autoridade competente, por escrito\n\n‚öñÔ∏è **Base Legal**: Lei 14.133/2021, art. 78\n\n‚ö†Ô∏è **Aten√ß√£o**: A impugna√ß√£o n√£o suspende os prazos previstos no edital, salvo decis√£o em contr√°rio da administra√ß√£o.",
        confidence: 0.97,
        references: [
          { law: "Lei 14.133/2021", article: "Art. 78", relevance: 0.98 }
        ]
      },
      {
        keywords: ['esclarecimento', 'd√∫vida'],
        response: "üìã **PRAZOS PARA PEDIDOS DE ESCLARECIMENTO:**\n\nüïê **At√© 3 dias √∫teis** antes da data fixada para abertura das propostas (art. 78, Lei 14.133/2021)\n\nüìß **Resposta**: A administra√ß√£o deve responder em at√© 2 dias √∫teis\n\n‚öñÔ∏è **Base Legal**: Lei 14.133/2021, art. 78, ¬ß1¬∫\n\nüí° **Importante**: As respostas ser√£o divulgadas a todos os interessados.",
        confidence: 0.96,
        references: [
          { law: "Lei 14.133/2021", article: "Art. 78, ¬ß1¬∫", relevance: 0.95 }
        ]
      }
    ]
  },
  
  mei_microempresa: {
    keywords: ['mei', 'microempresa', 'me', 'epp', 'pequeno porte', 'micro'],
    responses: [
      {
        keywords: ['participar', 'licita√ß√£o', 'valor'],
        response: "üìã **MEI/ME/EPP EM LICITA√á√ïES:**\n\n‚úÖ **PODE participar**: N√£o h√° limita√ß√£o de valor para participa√ß√£o de MEI em licita√ß√µes\n\nüéØ **Benef√≠cios garantidos:**\n‚Ä¢ **Cota de 25%** - Reserva de at√© 25% do objeto para ME/EPP (art. 48, LC 123/2006)\n‚Ä¢ **Empate ficto** - Prefer√™ncia quando proposta for at√© 10% superior √† melhor\n‚Ä¢ **Regulariza√ß√£o posterior** - 5 dias √∫teis ap√≥s habilita√ß√£o\n‚Ä¢ **Subcontrata√ß√£o** - 30% obrigat√≥rio para grandes empresas\n\n‚öñÔ∏è **Base Legal**: LC 123/2006, arts. 44 a 49",
        confidence: 0.95,
        references: [
          { law: "LC 123/2006", article: "Arts. 44-49", relevance: 0.98 },
          { law: "Lei 14.133/2021", article: "Art. 26", relevance: 0.90 }
        ]
      },
      {
        keywords: ['empate', 'ficto', 'desempate'],
        response: "üìã **EMPATE FICTO PARA ME/EPP:**\n\nü•á **Como funciona**: ME/EPP tem prefer√™ncia quando sua proposta for at√© **10% superior** √† proposta de menor pre√ßo\n\n‚ö° **Procedimento:**\n1. ME/EPP √© convocada para apresentar nova proposta\n2. Prazo de **5 minutos** no preg√£o eletr√¥nico\n3. Nova proposta deve ser **inferior** √† de menor pre√ßo\n\n‚öñÔ∏è **Base Legal**: LC 123/2006, art. 45\n\nüí° **Importante**: S√≥ vale se a ME/EPP estiver entre as 3 melhores propostas.",
        confidence: 0.97,
        references: [
          { law: "LC 123/2006", article: "Art. 45", relevance: 0.98 }
        ]
      }
    ]
  },

  documentos: {
    keywords: ['documento', 'habilita√ß√£o', 'certid√£o', 'cnd', 'exigido', 'obrigat√≥rio'],
    responses: [
      {
        keywords: ['habilita√ß√£o', 'obrigat√≥rio', 'necess√°rio'],
        response: "üìã **DOCUMENTOS OBRIGAT√ìRIOS PARA HABILITA√á√ÉO:**\n\nüìÑ **1. HABILITA√á√ÉO JUR√çDICA:**\n‚Ä¢ Ato constitutivo (contrato social, estatuto)\n‚Ä¢ CNPJ ativo\n‚Ä¢ Procura√ß√£o (se representado)\n\nüí∞ **2. REGULARIDADE FISCAL:**\n‚Ä¢ CND Federal (Receita Federal)\n‚Ä¢ CND Estadual e Municipal\n‚Ä¢ CND FGTS\n‚Ä¢ CND Trabalhista (TST)\n\nüíµ **3. QUALIFICA√á√ÉO ECON√îMICO-FINANCEIRA:**\n‚Ä¢ Balan√ßo patrimonial do √∫ltimo exerc√≠cio\n‚Ä¢ CND de fal√™ncia e concordata\n\nüîß **4. QUALIFICA√á√ÉO T√âCNICA:**\n‚Ä¢ Atestados de capacidade t√©cnica\n‚Ä¢ Registro profissional (quando exigido)\n\n‚öñÔ∏è **Base Legal**: Lei 14.133/2021, arts. 62-67",
        confidence: 0.96,
        references: [
          { law: "Lei 14.133/2021", article: "Arts. 62-67", relevance: 0.95 }
        ]
      }
    ]
  },

  inexigibilidade: {
    keywords: ['inexigibilidade', 'inexig√≠vel', 'competi√ß√£o', 'imposs√≠vel'],
    responses: [
      {
        keywords: ['quando', 'casos', 'situa√ß√µes'],
        response: "üìã **INEXIGIBILIDADE DE LICITA√á√ÉO:**\n\n‚ùå **Quando N√ÉO √© poss√≠vel competir:**\n\nüéØ **Art. 74, Lei 14.133/2021:**\n‚Ä¢ **Fornecedor exclusivo** - √önico no mercado\n‚Ä¢ **Servi√ßos t√©cnicos especializados** - Natureza singular\n‚Ä¢ **Artista consagrado** - Not√≥ria especializa√ß√£o\n\nüîç **Requisitos essenciais:**\n‚úì **Inviabilidade de competi√ß√£o**\n‚úì **Singularidade do objeto**\n‚úì **Not√≥ria especializa√ß√£o**\n\n‚ö†Ô∏è **Cuidado**: Inexigibilidade ‚â† Dispensa\n\n‚öñÔ∏è **Base Legal**: Lei 14.133/2021, art. 74",
        confidence: 0.94,
        references: [
          { law: "Lei 14.133/2021", article: "Art. 74", relevance: 0.98 }
        ]
      }
    ]
  },

  suspenso: {
    keywords: ['suspenso', 'suspens√£o', 'san√ß√£o', 'penalidade', 'impedido'],
    responses: [
      {
        keywords: ['participar', 'nova', 'licita√ß√£o'],
        response: "üìã **EMPRESA SUSPENSA - PARTICIPA√á√ÉO EM LICITA√á√ïES:**\n\n‚ùå **Durante a suspens√£o**: PROIBIDA a participa√ß√£o em qualquer licita√ß√£o do √≥rg√£o que aplicou a penalidade\n\n‚è∞ **Prazo**: At√© 2 anos (art. 156, Lei 14.133/2021)\n\nüåê **√Çmbito**: Apenas no √≥rg√£o sancionador (n√£o se estende a outros √≥rg√£os)\n\n‚úÖ **Ap√≥s o prazo**: Empresa pode voltar a participar normalmente\n\nüîç **Verifica√ß√£o**: Consultar SICAF ou sistema do √≥rg√£o\n\n‚öñÔ∏è **Base Legal**: Lei 14.133/2021, arts. 155-156",
        confidence: 0.93,
        references: [
          { law: "Lei 14.133/2021", article: "Arts. 155-156", relevance: 0.95 }
        ]
      }
    ]
  }
};

// Health check
app.get('/health', (req, res) => {
  res.json({ status: 'ok', message: 'LicitaF√°cil Pro Demo Server' });
});

// Auth endpoints
app.post('/auth/login', (req, res) => {
  const { email, password } = req.body;
  const user = users.find(u => u.email === email);
  
  if (user) {
    res.json({
      success: true,
      data: {
        user: { id: user.id, name: user.name, email: user.email, role: user.role },
        token: 'demo-jwt-token-' + user.id
      }
    });
  } else {
    res.status(401).json({ success: false, message: 'Credenciais inv√°lidas' });
  }
});

// Sistema de logs detalhado
const conversationLogs = [];

function logConversation(userMessage, response, moduleOrigin, moduleDestination, userId = 'demo-user') {
  const logEntry = {
    timestamp: new Date().toISOString(),
    userId: userId,
    userMessage: userMessage,
    moduleOrigin: moduleOrigin || 'chat',
    moduleDestination: moduleDestination,
    response: response.response || response,
    confidence: response.confidence || 0,
    category: response.category || 'unknown'
  };
  
  conversationLogs.push(logEntry);
  console.log(`üìù [${logEntry.timestamp}] ${userId}: "${userMessage}" -> ${moduleDestination} (${response.confidence || 'N/A'})`);
  
  // Manter apenas os √∫ltimos 100 logs em mem√≥ria
  if (conversationLogs.length > 100) {
    conversationLogs.shift();
  }
}

// Fun√ß√£o de encaminhamento inteligente aprimorada - NUNCA retorna erro gen√©rico
function encaminharParaModulo(mensagemUsuario, userId = 'demo-user') {
  const query = mensagemUsuario.toLowerCase();
  
  // Detectar categoria automaticamente com melhor algoritmo
  let bestCategory = 'juridico'; // padr√£o sempre √∫til
  let bestScore = 0;
  let fallbackUsed = false;
  
  for (const [category, config] of Object.entries(categoryClassifier)) {
    let score = 0;
    const keywordMatches = config.keywords.filter(keyword => query.includes(keyword));
    
    // Algoritmo aprimorado de pontua√ß√£o
    score = keywordMatches.length * 15; // Aumentar peso dos matches
    score += (6 - config.priority) * 3; // Maior peso para prioridade
    
    // Bonifica√ß√£o para matches exatos e contextuais
    keywordMatches.forEach(match => {
      if (query.includes(match + ' ') || query.includes(' ' + match) || query.startsWith(match) || query.endsWith(match)) {
        score += 8; // Aumentar bonifica√ß√£o
      }
      // Bonifica√ß√£o extra para palavras-chave cr√≠ticas
      if (['prazo', 'lei', 'recurso', 'documento', 'licita√ß√£o'].includes(match)) {
        score += 10;
      }
    });
    
    if (score > bestScore) {
      bestScore = score;
      bestCategory = category;
    }
  }
  
  // Se pontua√ß√£o muito baixa, usar fallback inteligente baseado no contexto
  if (bestScore < 5) {
    bestCategory = inferirCategoriaSemantica(query);
    fallbackUsed = true;
    console.log(`üîÑ Fallback sem√¢ntico ativado: ${bestCategory}`);
  }
  
  console.log(`üéØ Categoria final: ${bestCategory} (score: ${bestScore}${fallbackUsed ? ' + fallback' : ''})`);
  
  // Chamar o m√≥dulo apropriado
  const module = modules[bestCategory];
  let result = module.processQuery(mensagemUsuario, { 
    userId, 
    originalCategory: bestCategory,
    fallbackUsed,
    score: bestScore 
  });
  
  // Garantir que sempre temos uma resposta √∫til
  if (!result || !result.response || result.response.length < 10) {
    result = gerarRespostaProativaPersonalizada(mensagemUsuario, bestCategory);
  }
  
  // Formatar resposta sempre √∫til e proativa
  let finalResponse = result.response;
  
  // Se foi encaminhado, explicar de forma transparente e √∫til
  if (bestCategory !== 'juridico') {
    const moduleNames = {
      tecnico: 'Suporte T√©cnico',
      financeiro: 'Consultoria Financeira', 
      operacional: 'Suporte Operacional',
      estrategico: 'Consultoria Estrat√©gica'
    };
    
    finalResponse = `üîÄ **Identifiquei que sua pergunta se relaciona com ${moduleNames[bestCategory]}. Aqui est√° a orienta√ß√£o:**\n\n${finalResponse}`;
  }
  
  // Se usou fallback, ser ainda mais proativo
  if (fallbackUsed) {
    finalResponse += `\n\nüí° **N√£o encontrou exatamente o que procurava?** Digite de forma mais espec√≠fica ou use comandos como:\n‚Ä¢ \`/juridico [sua pergunta]\` - Para quest√µes legais\n‚Ä¢ \`/tecnico [sua pergunta]\` - Para quest√µes t√©cnicas\n‚Ä¢ \`/financeiro [sua pergunta]\` - Para quest√µes financeiras`;
  }
  
  const response = {
    response: finalResponse,
    confidence: Math.max(result.confidence, categoryClassifier[bestCategory].fallbackScore),
    module: bestCategory,
    category: result.category || 'geral',
    redirected: bestCategory !== 'juridico',
    originalQuery: mensagemUsuario,
    fallbackUsed,
    intelligentRouting: true
  };
  
  // Log da conversa
  logConversation(mensagemUsuario, response, 'chat', bestCategory, userId);
  
  return response;
}

// Fun√ß√£o para inferir categoria sem√¢ntica quando keywords n√£o funcionam
function inferirCategoriaSemantica(query) {
  // An√°lise sem√¢ntica simples baseada em contexto
  if (query.includes('como') || query.includes('onde') || query.includes('quando')) {
    if (query.includes('site') || query.includes('portal') || query.includes('sistema')) {
      return 'tecnico';
    }
    if (query.includes('processo') || query.includes('etapa') || query.includes('funciona')) {
      return 'operacional';
    }
    return 'juridico'; // Perguntas gerais de "como" sobre licita√ß√µes s√£o jur√≠dicas
  }
  
  if (query.includes('posso') || query.includes('pode') || query.includes('permitido') || query.includes('direito')) {
    return 'juridico';
  }
  
  if (query.includes('custa') || query.includes('valor') || query.includes('dinheiro') || query.includes('pago')) {
    return 'financeiro';
  }
  
  if (query.includes('ganhar') || query.includes('vencer') || query.includes('melhor') || query.includes('estrat√©gia')) {
    return 'estrategico';
  }
  
  // Fallback inteligente baseado em comprimento e complexidade
  if (query.length < 20) {
    return 'juridico'; // Perguntas curtas geralmente s√£o conceituais
  }
  
  if (query.length > 100) {
    return 'estrategico'; // Perguntas longas geralmente s√£o estrat√©gicas
  }
  
  return 'juridico'; // Padr√£o mais seguro
}

// Fun√ß√£o para gerar resposta proativa personalizada
function gerarRespostaProativaPersonalizada(mensagemUsuario, categoria) {
  const respostasProativas = {
    juridico: {
      response: `‚öñÔ∏è **Orienta√ß√£o Jur√≠dica Personalizada**\n\nEntendi sua consulta sobre: "${mensagemUsuario}"\n\n‚úÖ **Posso ajudar com:**\n‚Ä¢ Prazos e procedimentos legais\n‚Ä¢ Documenta√ß√£o obrigat√≥ria\n‚Ä¢ Direitos e benef√≠cios ME/EPP/MEI\n‚Ä¢ Recursos e impugna√ß√µes\n‚Ä¢ Conformidade legal\n\nüí° **Para resposta mais espec√≠fica**, reformule perguntando:\n‚Ä¢ "Qual o prazo para...?"\n‚Ä¢ "Quais documentos para...?"\n‚Ä¢ "ME pode participar de...?"\n‚Ä¢ "Como impugnar...?"`,
      confidence: 0.8,
      category: 'orientacao'
    },
    tecnico: {
      response: `üíª **Suporte T√©cnico Personalizado**\n\nVi que voc√™ precisa de ajuda t√©cnica: "${mensagemUsuario}"\n\nüîß **Posso resolver:**\n‚Ä¢ Problemas de acesso e cadastro\n‚Ä¢ Envio de propostas e documentos\n‚Ä¢ Certificados digitais\n‚Ä¢ Navega√ß√£o em portais\n‚Ä¢ Erros e bugs\n\nüí° **Para suporte direcionado**, me diga:\n‚Ä¢ Qual plataforma est√° usando?\n‚Ä¢ Qual erro aparece?\n‚Ä¢ Em que etapa est√° travado?`,
      confidence: 0.8,
      category: 'suporte'
    },
    financeiro: {
      response: `üí∞ **Consultoria Financeira Personalizada**\n\nIdentifiquei que voc√™ tem d√∫vida financeira: "${mensagemUsuario}"\n\nüìä **Posso orientar sobre:**\n‚Ä¢ Forma√ß√£o de pre√ßos competitivos\n‚Ä¢ Gest√£o de custos e margens\n‚Ä¢ Impostos e benef√≠cios fiscais\n‚Ä¢ Pagamentos e faturamento\n‚Ä¢ Fluxo de caixa\n\nüí° **Para an√°lise espec√≠fica**, compartilhe:\n‚Ä¢ Tipo de servi√ßo/produto?\n‚Ä¢ Valor estimado do contrato?\n‚Ä¢ Sua margem atual?`,
      confidence: 0.8,
      category: 'consultoria'
    },
    operacional: {
      response: `‚öôÔ∏è **Gest√£o Operacional Personalizada**\n\nVejo que precisa de ajuda operacional: "${mensagemUsuario}"\n\nüìã **Posso organizar:**\n‚Ä¢ Fluxos e cronogramas\n‚Ä¢ Gest√£o de processos\n‚Ä¢ Acompanhamento de status\n‚Ä¢ Documenta√ß√£o e controles\n‚Ä¢ Execu√ß√£o de contratos\n\nüí° **Para planejamento eficaz**, me conte:\n‚Ä¢ Qual processo quer otimizar?\n‚Ä¢ Quantas licita√ß√µes acompanha?\n‚Ä¢ Onde sente mais dificuldade?`,
      confidence: 0.8,
      category: 'gestao'
    },
    estrategico: {
      response: `üéØ **Consultoria Estrat√©gica Personalizada**\n\nPercebo que busca orienta√ß√£o estrat√©gica: "${mensagemUsuario}"\n\nüèÜ **Posso desenvolver:**\n‚Ä¢ Estrat√©gias de competitividade\n‚Ä¢ An√°lise de oportunidades\n‚Ä¢ Networking e relacionamentos\n‚Ä¢ Posicionamento de mercado\n‚Ä¢ Crescimento sustent√°vel\n\nüí° **Para estrat√©gia personalizada**, me conte:\n‚Ä¢ H√° quanto tempo atua no mercado?\n‚Ä¢ Qual seu principal desafio?\n‚Ä¢ Que tipo de oportunidade busca?`,
      confidence: 0.8,
      category: 'estrategia'
    }
  };
  
  return respostasProativas[categoria] || respostasProativas.juridico;
}

// Fun√ß√£o para processamento direto de consultas jur√≠dicas (sem roteamento)
function processDirectLegalQuery(queryText, context = {}) {
  const query = queryText.toLowerCase();
  
  // Remover comandos se existirem
  const cleanQuery = query.replace(/^\/\w+\s*/, '');
  
  // Buscar na base de conhecimento jur√≠dica
  for (const [category, data] of Object.entries(legalKnowledgeBase)) {
    // Verificar se a query cont√©m palavras-chave da categoria
    const hasKeyword = data.keywords.some(keyword => cleanQuery.includes(keyword));
    
    if (hasKeyword) {
      // Buscar resposta espec√≠fica
      for (const responseItem of data.responses) {
        const hasSpecificKeyword = responseItem.keywords.some(keyword => 
          cleanQuery.includes(keyword)
        );
        
        if (hasSpecificKeyword) {
          return {
            response: responseItem.response,
            confidence: responseItem.confidence,
            references: responseItem.references,
            category: category,
            module: 'juridico'
          };
        }
      }
    }
  }
  
  // Fallback para respostas jur√≠dicas gen√©ricas
  return {
    response: "‚öñÔ∏è **Assistente Jur√≠dico - LicitaF√°cil Pro**\n\nPara uma resposta mais espec√≠fica, reformule sua pergunta incluindo:\n\n**üìã Exemplos de consultas:**\n‚Ä¢ \"Qual o prazo para recurso no preg√£o?\"\n‚Ä¢ \"Quais documentos ME precisa apresentar?\"\n‚Ä¢ \"Como impugnar um edital?\"\n‚Ä¢ \"Qual a diferen√ßa entre preg√£o e concorr√™ncia?\"\n\nüí° **Dica**: Seja espec√≠fico sobre prazos, procedimentos ou documentos que precisa saber!",
    confidence: 0.7,
    category: 'juridico',
    module: 'juridico'
  };
}

// Fun√ß√£o para analisar consulta e gerar resposta - SEMPRE √öTIL
function generateLegalResponse(queryText) {
  // Esta fun√ß√£o n√£o deve mais ser usada - usar encaminharParaModulo
  console.warn('‚ö†Ô∏è generateLegalResponse chamada - usar encaminharParaModulo');
  return processDirectLegalQuery(queryText);
}

// Gerar perguntas relacionadas baseadas na categoria
function generateFollowUpQuestions(category, queryText) {
  const followUpMap = {
    prazos: [
      "Quer saber sobre prazos de outras modalidades?",
      "Precisa de orienta√ß√£o sobre como calcular dias √∫teis?",
      "Gostaria de saber sobre prazos para ME/EPP?"
    ],
    mei_microempresa: [
      "Quer saber mais sobre outros benef√≠cios para ME/EPP?",
      "Precisa de orienta√ß√£o sobre como comprovar o porte da empresa?",
      "Gostaria de saber sobre subcontrata√ß√£o obrigat√≥ria?"
    ],
    documentos: [
      "Precisa de orienta√ß√£o sobre onde obter essas certid√µes?",
      "Quer saber sobre prazos de validade dos documentos?",
      "Gostaria de conhecer os benef√≠cios de regulariza√ß√£o para ME/EPP?"
    ],
    inexigibilidade: [
      "Quer saber sobre a diferen√ßa entre inexigibilidade e dispensa?",
      "Precisa de orienta√ß√£o sobre como justificar a inexigibilidade?",
      "Gostaria de conhecer outros casos de contrata√ß√£o direta?"
    ],
    suspenso: [
      "Quer saber sobre outras san√ß√µes em licita√ß√µes?",
      "Precisa de orienta√ß√£o sobre como recorrer de penalidades?",
      "Gostaria de saber como consultar san√ß√µes aplicadas?"
    ],
    generic: [
      "Gostaria de fazer uma pergunta mais espec√≠fica?",
      "Precisa de orienta√ß√£o sobre algum procedimento?",
      "Quer saber sobre benef√≠cios para ME/EPP?"
    ]
  };
  
  return followUpMap[category] || followUpMap.generic;
}

// Legal AI endpoints - Sistema inteligente de roteamento
app.post('/legal-ai/query', (req, res) => {
  const { queryText, userId = 'demo-user' } = req.body;
  
  console.log(`üìù Consulta recebida: "${queryText}"`);
  
  // Simular processamento (1-3 segundos)
  const processingTime = Math.random() * 2000 + 1000;
  
  setTimeout(() => {
    // Usar novo sistema de encaminhamento inteligente
    const result = encaminharParaModulo(queryText, userId);
    
    const response = {
      success: true,
      data: {
        id: 'query-' + Date.now(),
        queryText,
        responseText: result.response,
        confidenceScore: result.confidence,
        module: result.module,
        redirected: result.redirected,
        legalReferences: generateLegalReferences(result),
        followUpQuestions: generateFollowUpQuestions(result.category, queryText),
        category: result.category,
        processingTime: Math.round(processingTime),
        conversationalTone: true,
        naturalLanguage: true
      }
    };
    
    console.log(`‚úÖ Resposta gerada via ${result.module} (${Math.round(processingTime)}ms): ${result.response.substring(0, 100)}...`);
    
    res.json(response);
  }, processingTime);
});

// Fun√ß√£o para gerar refer√™ncias baseadas no m√≥dulo
function generateLegalReferences(result) {
  const moduleReferences = {
    juridico: [
      { law: "Lei 14.133/2021", article: "Nova Lei de Licita√ß√µes", relevance: 0.95 },
      { law: "Lei 10.520/2002", article: "Lei do Preg√£o", relevance: 0.90 }
    ],
    tecnico: [
      { law: "Decreto 10.024/2019", article: "Preg√£o Eletr√¥nico", relevance: 0.85 },
      { law: "IN SEGES 05/2017", article: "Contrata√ß√£o de TI", relevance: 0.80 }
    ],
    financeiro: [
      { law: "Lei 14.133/2021", article: "Arts. 126-130", relevance: 0.90 },
      { law: "LC 123/2006", article: "Benef√≠cios ME/EPP", relevance: 0.85 }
    ],
    operacional: [
      { law: "Lei 14.133/2021", article: "Procedimentos", relevance: 0.85 },
      { law: "Decreto 10.024/2019", article: "Fluxos operacionais", relevance: 0.80 }
    ],
    estrategico: [
      { law: "Lei 14.133/2021", article: "Princ√≠pios", relevance: 0.75 },
      { law: "LC 123/2006", article: "Oportunidades ME/EPP", relevance: 0.80 }
    ]
  };
  
  return (moduleReferences[result.module] || moduleReferences.juridico).map(ref => ({
    documentNumber: ref.law,
    title: ref.law,
    article: ref.article,
    relevance: ref.relevance,
    excerpt: `Refer√™ncia: ${ref.law}, ${ref.article}`
  }));
}

// Commands endpoints
app.post('/legal-ai/commands/:command', (req, res) => {
  const { command } = req.params;
  const { args } = req.body;
  
  const fullQuery = `/${command} ${args}`;
  console.log(`ü§ñ Comando recebido: ${fullQuery}`);
  
  // Processar como consulta normal
  const result = encaminharParaModulo(fullQuery);
  
  res.json({
    success: true,
    data: {
      id: 'command-' + Date.now(),
      command,
      args,
      queryText: fullQuery,
      responseText: result.response,
      confidenceScore: result.confidence,
      legalReferences: result.references,
      followUpQuestions: generateFollowUpQuestions(result.category, fullQuery),
      timestamp: new Date().toISOString()
    }
  });
});

// Opportunities endpoints
app.get('/opportunities', (req, res) => {
  res.json({
    success: true,
    data: opportunities,
    total: opportunities.length
  });
});

// Queries history - Agora com logs detalhados
app.get('/legal-ai/queries', (req, res) => {
  res.json({
    success: true,
    data: queries,
    conversationLogs: conversationLogs.slice(-20) // √öltimas 20 conversas
  });
});

// Endpoint para logs de auditoria
app.get('/legal-ai/logs', (req, res) => {
  const { userId, module, startDate, endDate } = req.query;
  
  let filteredLogs = [...conversationLogs];
  
  if (userId) {
    filteredLogs = filteredLogs.filter(log => log.userId === userId);
  }
  
  if (module) {
    filteredLogs = filteredLogs.filter(log => log.moduleDestination === module);
  }
  
  if (startDate) {
    filteredLogs = filteredLogs.filter(log => new Date(log.timestamp) >= new Date(startDate));
  }
  
  if (endDate) {
    filteredLogs = filteredLogs.filter(log => new Date(log.timestamp) <= new Date(endDate));
  }
  
  res.json({
    success: true,
    data: filteredLogs,
    total: filteredLogs.length,
    modules: {
      juridico: filteredLogs.filter(l => l.moduleDestination === 'juridico').length,
      tecnico: filteredLogs.filter(l => l.moduleDestination === 'tecnico').length,
      financeiro: filteredLogs.filter(l => l.moduleDestination === 'financeiro').length,
      operacional: filteredLogs.filter(l => l.moduleDestination === 'operacional').length,
      estrategico: filteredLogs.filter(l => l.moduleDestination === 'estrategico').length
    }
  });
});

// Statistics
app.get('/legal-ai/statistics', (req, res) => {
  res.json({
    success: true,
    data: {
      total: 1247,
      accuracy: 94.3,
      avgResponseTime: 2.1,
      userSatisfaction: 4.7,
      totalOpportunities: 3892,
      conversionRate: 23.4
    }
  });
});

// Health check for legal AI
app.get('/legal-ai/health', (req, res) => {
  res.json({
    success: true,
    data: {
      status: 'healthy',
      pendingQueries: 0,
      pendingAnalyses: 0,
      timestamp: new Date().toISOString()
    }
  });
});

// Catch all
app.get('*', (req, res) => {
  res.json({ 
    message: 'LicitaF√°cil Pro Demo API - IA Jur√≠dica Avan√ßada',
    endpoint: req.path,
    method: req.method,
    docs: 'http://localhost:3001/docs',
    examples: [
      'POST /legal-ai/query - {"queryText": "qual o prazo para recurso no preg√£o?"}',
      'POST /legal-ai/query - {"queryText": "MEI pode participar de licita√ß√£o de R$ 100mil?"}',
      'POST /legal-ai/query - {"queryText": "documentos obrigat√≥rios para habilita√ß√£o"}'
    ]
  });
});

app.listen(PORT, () => {
  console.log(`üöÄ LicitaF√°cil Pro Demo Server (IA Avan√ßada) rodando em http://localhost:${PORT}`);
  console.log(`üìö Teste: curl http://localhost:${PORT}/health`);
  console.log(`‚öñÔ∏è IA Jur√≠dica: curl -X POST http://localhost:${PORT}/legal-ai/query -H "Content-Type: application/json" -d '{"queryText":"qual o prazo para recurso no preg√£o eletr√¥nico?"}'`);
  console.log(`ü§ñ Base de conhecimento carregada com ${Object.keys(legalKnowledgeBase).length} categorias`);
});