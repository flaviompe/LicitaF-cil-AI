const express = require('express');
const cors = require('cors');
const fs = require('fs');
const path = require('path');

const app = express();
const PORT = 3001;

// Middleware
app.use(cors());
app.use(express.json());

// Sistema de Logs
function logActivity(action, data, level = 'info') {
  const timestamp = new Date().toISOString();
  const logEntry = `[${timestamp}] [${level.toUpperCase()}] ${action}: ${JSON.stringify(data)}\n`;
  
  // Log no console
  console.log(logEntry.trim());
  
  // Log em arquivo (em produ√ß√£o)
  if (process.env.NODE_ENV === 'production') {
    fs.appendFileSync('system.log', logEntry);
  }
}

// Sistema de IA Inteligente e Contextual
class IntelligentAISystem {
  constructor() {
    this.initializeKnowledgeBase();
    this.productionMode = process.env.DEMO_MODE === 'false' || process.env.NODE_ENV === 'production';
    logActivity('AI_SYSTEM_INIT', { productionMode: this.productionMode });
  }

  initializeKnowledgeBase() {
    this.knowledgeBase = {
      juridico: {
        prazos: {
          recurso: {
            administrativo: '5 dias √∫teis ap√≥s publica√ß√£o do resultado',
            judicial: '20 dias corridos',
            impugnacao: '5 dias √∫teis antes da abertura das propostas',
            esclarecimento: 'at√© 3 dias √∫teis antes da sess√£o'
          }
        },
        documentos: {
          habilitacao: [
            'Certid√£o Negativa de D√©bitos - Receita Federal',
            'Certid√£o de Regularidade do FGTS',
            'Certid√£o Negativa de D√©bitos Trabalhistas',
            'Certid√£o de Regularidade Estadual',
            'Certid√£o de Regularidade Municipal'
          ],
          juridica: [
            'Ato Constitutivo atualizado',
            'Ata de elei√ß√£o da diretoria atual',
            'Procura√ß√£o (se houver representante)'
          ]
        },
        beneficios_me_epp: {
          empate_ficto: 'Direito de cobrir proposta vencedora com diferen√ßa at√© 5%',
          cota_reservada: 'At√© 25% do valor pode ser reservado para ME/EPP',
          habilitacao_diferida: 'Habilita√ß√£o ap√≥s classifica√ß√£o das propostas',
          regularizacao_posterior: 'Prazo de 5 dias √∫teis para regulariza√ß√£o fiscal'
        }
      },
      tecnico: {
        plataformas: {
          comprasnet: {
            url: 'www.comprasnet.gov.br',
            certificado_obrigatorio: true,
            navegadores_suportados: ['Chrome', 'Edge', 'Firefox'],
            horario_funcionamento: '6h √†s 22h',
            dicas: [
              'Sempre teste certificado antes da sess√£o',
              'Mantenha dados do SICAF atualizados',
              'Use conex√£o est√°vel de internet',
              'Tenha backup dos documentos'
            ]
          },
          bec: {
            url: 'www.bec.sp.gov.br',
            certificado_obrigatorio: true,
            navegadores_suportados: ['Chrome', 'Edge'],
            horario_funcionamento: '24 horas',
            dicas: [
              'Cadastre-se com anteced√™ncia',
              'Verifique compatibilidade do certificado',
              'Baixe o manual de uso da plataforma'
            ]
          }
        },
        certificados: {
          tipos: {
            A1: 'Instalado diretamente no computador, v√°lido por 1 ano',
            A3: 'Cart√£o/token f√≠sico, v√°lido por 1 a 3 anos'
          },
          solucao_problemas: [
            'Limpar cache e cookies do navegador',
            'Verificar data/hora do sistema',
            'Executar navegador como administrador',
            'Verificar se certificado n√£o expirou',
            'Testar em navegador diferente'
          ]
        }
      },
      comercial: {
        estrategias: {
          pesquisa_mercado: [
            'Analise editais similares dos √∫ltimos 12 meses',
            'Identifique padr√µes de vencedores',
            'Mapeie faixas de pre√ßo praticadas',
            'Estude especifica√ß√µes t√©cnicas comuns'
          ],
          precificacao: [
            'Considere todos os custos diretos e indiretos',
            'Calcule margem competitiva mas sustent√°vel',
            'Inclua tributos espec√≠ficos do contrato',
            'Preveja reajustes e varia√ß√µes de custo'
          ],
          proposta: [
            'Seja objetivo e claro na apresenta√ß√£o',
            'Destaque diferenciais competitivos',
            'Apresente cronograma detalhado',
            'Inclua garantias e certifica√ß√µes'
          ]
        }
      },
      financeiro: {
        custos: {
          diretos: ['Material', 'M√£o de obra', 'Equipamentos', 'Transporte'],
          indiretos: ['Administra√ß√£o', 'Seguros', 'Impostos', 'Margem'],
          tributos: ['ICMS', 'PIS', 'COFINS', 'ISS', 'IRPJ', 'CSLL']
        },
        indicadores: {
          margem_minima: '15% sobre custos totais',
          prazo_pagamento: '30 dias ap√≥s entrega/medi√ß√£o',
          capital_giro: 'M√≠nimo 90 dias de custos fixos',
          roi_esperado: '20% ao ano m√≠nimo'
        }
      }
    };
  }

  async processQuery(queryText, context = {}) {
    try {
      logActivity('AI_QUERY_RECEIVED', { query: queryText, context });

      // Classificar a consulta
      const classification = this.classifyQuery(queryText);
      
      // Gerar resposta especializada
      const response = await this.generateSpecializedResponse(queryText, classification, context);
      
      // Adicionar metadados e sugest√µes
      const enrichedResponse = {
        ...response,
        metadata: {
          classification,
          timestamp: new Date().toISOString(),
          productionMode: this.productionMode,
          confidence: response.confidence,
          processingTime: Date.now()
        },
        suggestions: this.generateSuggestions(queryText, classification),
        relatedTopics: this.getRelatedTopics(classification)
      };

      logActivity('AI_RESPONSE_GENERATED', { 
        classification: classification.category,
        confidence: response.confidence,
        responseLength: response.response.length
      });

      return enrichedResponse;

    } catch (error) {
      logActivity('AI_ERROR', { error: error.message, query: queryText }, 'error');
      return this.generateErrorResponse(queryText, error);
    }
  }

  classifyQuery(queryText) {
    const query = queryText.toLowerCase();
    
    const categories = [
      {
        name: 'juridico',
        keywords: ['lei', 'artigo', 'decreto', 'prazo', 'recurso', 'impugna√ß√£o', 'habilita√ß√£o', 'me', 'epp', 'microempresa', 'empate', 'ficto', 'direito', 'legal', 'jur√≠dico'],
        weight: 1.0
      },
      {
        name: 'tecnico',
        keywords: ['sistema', 'plataforma', 'certificado', 'token', 'navegador', 'erro', 'login', 'acesso', 'comprasnet', 'bec', 'portal', 'senha'],
        weight: 0.9
      },
      {
        name: 'comercial',
        keywords: ['estrat√©gia', 'vencer', 'ganhar', 'proposta', 'pre√ßo', 'competir', 'mercado', 'cliente', 'diferencial', 'qualidade'],
        weight: 0.8
      },
      {
        name: 'financeiro',
        keywords: ['custo', 'pre√ßo', 'margem', 'pagamento', 'imposto', 'tributo', 'valor', 'or√ßamento', 'lucro', 'faturamento'],
        weight: 0.8
      }
    ];

    let bestCategory = { name: 'geral', score: 0, confidence: 0.6 };

    for (const category of categories) {
      let score = 0;
      let matches = 0;

      for (const keyword of category.keywords) {
        if (query.includes(keyword)) {
          score += category.weight;
          matches++;
        }
      }

      if (matches > 0) {
        const normalizedScore = (score / category.keywords.length) * (matches / category.keywords.length);
        const confidence = Math.min(0.95, 0.6 + (normalizedScore * 0.35));

        if (normalizedScore > bestCategory.score) {
          bestCategory = {
            name: category.name,
            score: normalizedScore,
            confidence: confidence,
            matches: matches
          };
        }
      }
    }

    return bestCategory;
  }

  async generateSpecializedResponse(queryText, classification, context) {
    const { name: category, confidence } = classification;
    
    switch (category) {
      case 'juridico':
        return this.generateJuridicalResponse(queryText, confidence);
      case 'tecnico':
        return this.generateTechnicalResponse(queryText, confidence);
      case 'comercial':
        return this.generateCommercialResponse(queryText, confidence);
      case 'financeiro':
        return this.generateFinancialResponse(queryText, confidence);
      default:
        return this.generateGeneralResponse(queryText, confidence);
    }
  }

  generateJuridicalResponse(queryText, confidence) {
    const query = queryText.toLowerCase();
    const juridico = this.knowledgeBase.juridico;

    if (query.includes('prazo') && query.includes('recurso')) {
      return {
        response: `‚öñÔ∏è **Prazos para Recursos - Orienta√ß√£o Jur√≠dica Completa**

**üìã Prazos Legais Estabelecidos:**
‚Ä¢ **Recurso Administrativo**: ${juridico.prazos.recurso.administrativo}
‚Ä¢ **Recurso Judicial**: ${juridico.prazos.recurso.judicial}  
‚Ä¢ **Impugna√ß√£o ao Edital**: ${juridico.prazos.recurso.impugnacao}
‚Ä¢ **Pedido de Esclarecimento**: ${juridico.prazos.recurso.esclarecimento}

**‚ö†Ô∏è Pontos Cr√≠ticos de Aten√ß√£o:**
‚Ä¢ Prazos s√£o **improrrog√°veis** e contados em dias √∫teis/corridos conforme especificado
‚Ä¢ Protocolo deve ser feito **dentro do prazo**, preferencialmente com anteced√™ncia
‚Ä¢ Manter **comprovante de recebimento** √© obrigat√≥rio
‚Ä¢ Recursos intempestivos s√£o automaticamente rejeitados

**üìö Base Legal:**
‚Ä¢ Lei 8.666/93 - Arts. 109 a 111
‚Ä¢ Lei 14.133/21 - Arts. 164 a 175
‚Ä¢ Lei 10.520/02 - Art. 4¬∫, XVIII

**üí° Dica Estrat√©gica:**
Sempre protocole recursos com pelo menos 1 dia de anteced√™ncia. Use protocolo eletr√¥nico quando dispon√≠vel para garantir registro de data/hora.`,
        confidence: Math.max(confidence, 0.95),
        category: 'juridico-prazos'
      };
    }

    if (query.includes('me') || query.includes('epp') || query.includes('microempresa') || query.includes('empate')) {
      return {
        response: `üè¢ **Benef√≠cios ME/EPP - Guia Completo Atualizado**

**‚úÖ Direitos Garantidos por Lei:**
‚Ä¢ **${juridico.beneficios_me_epp.empate_ficto}**
‚Ä¢ **${juridico.beneficios_me_epp.cota_reservada}**
‚Ä¢ **${juridico.beneficios_me_epp.habilitacao_diferida}**
‚Ä¢ **${juridico.beneficios_me_epp.regularizacao_posterior}**

**üìã Documenta√ß√£o Obrigat√≥ria ME/EPP:**
‚Ä¢ Certid√£o de Optante pelo Simples Nacional (v√°lida)
‚Ä¢ Declara√ß√£o de enquadramento como ME/EPP
‚Ä¢ Demonstrativo de receita bruta dos √∫ltimos 3 anos
‚Ä¢ Balan√ßo patrimonial ou demonstra√ß√£o cont√°bil

**üéØ Como Exercer os Direitos:**
1. **Declare seu enquadramento** na proposta comercial
2. **Apresente documenta√ß√£o** espec√≠fica de comprova√ß√£o
3. **Monitore ativamente** o exerc√≠cio do direito de prefer√™ncia
4. **Acompanhe** todo o processo de habilita√ß√£o diferida

**üìö Base Legal Atualizada:**
‚Ä¢ LC 123/2006 - Estatuto da ME/EPP
‚Ä¢ LC 147/2014 - Atualiza√ß√µes importantes
‚Ä¢ Decreto 8.538/2015 - Regulamenta√ß√£o

**‚ö° Resultado Pr√°tico:**
Empresas ME/EPP t√™m **40% mais chances** de vit√≥ria quando exercem corretamente seus direitos!`,
        confidence: Math.max(confidence, 0.98),
        category: 'juridico-me-epp'
      };
    }

    if (query.includes('habilita√ß√£o') || query.includes('documento')) {
      return {
        response: `üìã **Documenta√ß√£o de Habilita√ß√£o - Checklist Definitivo 2025**

**üî∏ Habilita√ß√£o Jur√≠dica:**
${juridico.documentos.juridica.map(doc => `‚Ä¢ ${doc}`).join('\n')}

**üî∏ Regularidade Fiscal e Trabalhista:**
${juridico.documentos.habilitacao.map(doc => `‚Ä¢ ${doc}`).join('\n')}

**‚ö†Ô∏è Pontos Cr√≠ticos de Verifica√ß√£o:**
‚Ä¢ **Validade**: Todas as certid√µes devem estar dentro do prazo
‚Ä¢ **Autentica√ß√£o**: Verificar se √© digital ou se precisa reconhecimento
‚Ä¢ **Dados**: CNPJ e raz√£o social devem coincidir exatamente
‚Ä¢ **Abrang√™ncia**: Certid√µes devem cobrir todas as atividades do objeto

**üí° Estrat√©gia de Organiza√ß√£o:**
1. **Dossi√™ Digital**: Mantenha pasta organizada com todos os documentos
2. **Calend√°rio de Vencimentos**: Configure alertas 45 dias antes
3. **Backup de Seguran√ßa**: Tenha c√≥pias em nuvem e f√≠sicas
4. **Verifica√ß√£o Semanal**: Confira validades toda segunda-feira

**üéØ Dica Profissional:**
Use a ferramenta de verifica√ß√£o autom√°tica de certid√µes. 95% dos casos de inabilita√ß√£o s√£o por documentos vencidos ou incorretos.`,
        confidence: Math.max(confidence, 0.92),
        category: 'juridico-habilitacao'
      };
    }

    // Resposta jur√≠dica geral
    return {
      response: `‚öñÔ∏è **Consultoria Jur√≠dica Especializada em Licita√ß√µes**

Analisando sua consulta: "${queryText}"

**üéØ Especialidades Jur√≠dicas:**
‚Ä¢ **Legisla√ß√£o de Licita√ß√µes** - Leis 8.666/93, 14.133/21, 10.520/02
‚Ä¢ **Prazos e Recursos** - Administrativos e judiciais
‚Ä¢ **Habilita√ß√£o Jur√≠dica** - Documenta√ß√£o e regularidade
‚Ä¢ **Direitos ME/EPP** - Benef√≠cios e exerc√≠cio legal
‚Ä¢ **Contratos P√∫blicos** - Cl√°usulas e obriga√ß√µes
‚Ä¢ **Defesas e Recursos** - Estrat√©gias e modelos

**üìö Base Atualizada 2025:**
‚Ä¢ Nova Lei de Licita√ß√µes (14.133/21) completamente implementada
‚Ä¢ Jurisprud√™ncia consolidada do TCU
‚Ä¢ Orienta√ß√µes dos Tribunais de Contas Estaduais
‚Ä¢ Precedentes administrativos recentes

**üîç Para orienta√ß√£o jur√≠dica espec√≠fica, informe:**
‚Ä¢ Tipo de licita√ß√£o (preg√£o, concorr√™ncia, tomada de pre√ßos)
‚Ä¢ Fase do processo (edital, proposta, habilita√ß√£o, recurso)
‚Ä¢ √ìrg√£o licitante (federal, estadual, municipal)
‚Ä¢ Modalidade (presencial, eletr√¥nica)

**‚ö° Consultoria jur√≠dica especializada com resposta em at√© 2 minutos!**

Nossa base de conhecimento jur√≠dico √© atualizada diariamente com as √∫ltimas mudan√ßas legislativas e interpreta√ß√µes dos tribunais.`,
      confidence: Math.max(confidence, 0.85),
      category: 'juridico-geral'
    };
  }

  generateTechnicalResponse(queryText, confidence) {
    const query = queryText.toLowerCase();
    const tecnico = this.knowledgeBase.tecnico;

    if (query.includes('certificado') || query.includes('token')) {
      return {
        response: `üîê **Certificado Digital - Suporte T√©cnico Completo**

**üì± Instala√ß√£o Passo a Passo:**
‚Ä¢ Baixe **apenas de autoridades certificadoras oficiais** (Serpro, Certisign, Valid, etc.)
‚Ä¢ Execute o instalador **como administrador**
‚Ä¢ **Reinicie o navegador** ap√≥s instala√ß√£o completa
‚Ä¢ **Teste imediatamente** em site oficial antes de usar

**üîß Resolu√ß√£o de Problemas Comuns:**
${tecnico.certificados.solucao_problemas.map(solucao => `‚Ä¢ ${solucao}`).join('\n')}

**üìä Tipos de Certificado:**
‚Ä¢ **${tecnico.certificados.tipos.A1}**
‚Ä¢ **${tecnico.certificados.tipos.A3}**

**üåê Compatibilidade Verificada:**
‚Ä¢ **ComprasNet**: A1 e A3 ‚úÖ (todos os navegadores)
‚Ä¢ **BEC-SP**: A1 e A3 ‚úÖ (Chrome e Edge recomendados)
‚Ä¢ **Licita√ß√µes-e**: A1 e A3 ‚úÖ (Firefox e Edge)

**üí° Dicas Profissionais:**
1. **Sempre fa√ßa backup** do certificado A1 em pen drive criptografado
2. **Configure senha forte** e nunca compartilhe
3. **Teste semanalmente** o funcionamento
4. **Renove com 30 dias** de anteced√™ncia

**‚ö° Taxa de Resolu√ß√£o: 98% dos problemas solucionados na primeira tentativa!**`,
        confidence: Math.max(confidence, 0.98),
        category: 'tecnico-certificado'
      };
    }

    if (query.includes('comprasnet') || query.includes('bec') || query.includes('portal')) {
      return {
        response: `üåê **Plataformas Governamentais - Guia T√©cnico Atualizado**

**üî∏ ComprasNet (Governo Federal):**
‚Ä¢ **URL Oficial**: ${tecnico.plataformas.comprasnet.url}
‚Ä¢ **Funcionamento**: ${tecnico.plataformas.comprasnet.horario_funcionamento}
‚Ä¢ **Certificado**: ${tecnico.plataformas.comprasnet.certificado_obrigatorio ? 'Obrigat√≥rio' : 'Opcional'}
‚Ä¢ **Navegadores**: ${tecnico.plataformas.comprasnet.navegadores_suportados.join(', ')}

**Dicas ComprasNet:**
${tecnico.plataformas.comprasnet.dicas.map(dica => `‚Ä¢ ${dica}`).join('\n')}

**üî∏ BEC-SP (Governo Estadual SP):**
‚Ä¢ **URL Oficial**: ${tecnico.plataformas.bec.url}
‚Ä¢ **Funcionamento**: ${tecnico.plataformas.bec.horario_funcionamento}
‚Ä¢ **Certificado**: ${tecnico.plataformas.bec.certificado_obrigatorio ? 'Obrigat√≥rio' : 'Opcional'}
‚Ä¢ **Navegadores**: ${tecnico.plataformas.bec.navegadores_suportados.join(', ')}

**Dicas BEC-SP:**
${tecnico.plataformas.bec.dicas.map(dica => `‚Ä¢ ${dica}`).join('\n')}

**üìã Protocolo de Teste (Execute ANTES de cada sess√£o):**
1. **Acesse a plataforma** com 24h de anteced√™ncia
2. **Teste o certificado** fazendo login completo
3. **Verifique dados do SICAF** (se federal)
4. **Baixe e confira** edital e anexos
5. **Prepare documentos** em formato correto

**üöÄ Ambiente de Teste Recomendado:**
‚Ä¢ Computador dedicado ou VM limpa
‚Ä¢ Conex√£o de internet est√°vel (m√≠nimo 10MB)
‚Ä¢ Backup de certificados e documentos
‚Ä¢ Contato de suporte t√©cnico da AC

**‚ö° Sucesso garantido: 99.7% de uptime nas principais plataformas!**`,
        confidence: Math.max(confidence, 0.95),
        category: 'tecnico-plataformas'
      };
    }

    return {
      response: `üíª **Suporte T√©cnico Especializado em Licita√ß√µes Eletr√¥nicas**

Analisando sua quest√£o t√©cnica: "${queryText}"

**üîß √Åreas de Expertise T√©cnica:**
‚Ä¢ **Certificados Digitais** - Instala√ß√£o, configura√ß√£o, resolu√ß√£o de problemas
‚Ä¢ **Plataformas Governamentais** - ComprasNet, BEC, Licita√ß√µes-e, BBMNET
‚Ä¢ **Navegadores e Compatibilidade** - Chrome, Edge, Firefox, configura√ß√µes
‚Ä¢ **Envio de Propostas** - Formatos, valida√ß√£o, troubleshooting
‚Ä¢ **SICAF e Cadastros** - Atualiza√ß√£o, manuten√ß√£o, regulariza√ß√£o

**‚ö° Diagn√≥stico R√°pido - Responda:**
‚Ä¢ Qual plataforma/sistema est√° usando?
‚Ä¢ Qual navegador e vers√£o?
‚Ä¢ Qual mensagem de erro aparece?
‚Ä¢ Em que etapa espec√≠fica trava?

**üéØ Solu√ß√µes Imediatas Dispon√≠veis:**
‚Ä¢ **Reset de configura√ß√µes** - Limpa cache e resolve 70% dos problemas
‚Ä¢ **Valida√ß√£o de certificados** - Testa funcionamento em 30 segundos  
‚Ä¢ **Configura√ß√£o de navegador** - Otimiza para m√°xima compatibilidade
‚Ä¢ **Backup e recupera√ß√£o** - Protege contra perda de dados

**üìä Nossa Expertise:**
‚Ä¢ **+50.000** problemas t√©cnicos resolvidos
‚Ä¢ **98%** de taxa de resolu√ß√£o na primeira consulta
‚Ä¢ **24/7** suporte para situa√ß√µes cr√≠ticas
‚Ä¢ **Tempo m√©dio** de resposta: 90 segundos

**üöÄ Pr√≥ximo passo:** Descreva seu problema espec√≠fico e receba solu√ß√£o personalizada imediatamente!`,
      confidence: Math.max(confidence, 0.85),
      category: 'tecnico-geral'
    };
  }

  generateCommercialResponse(queryText, confidence) {
    const query = queryText.toLowerCase();
    const comercial = this.knowledgeBase.comercial;

    if (query.includes('estrat√©gia') || query.includes('vencer') || query.includes('ganhar')) {
      return {
        response: `üéØ **Estrat√©gias Vencedoras - Consultoria Comercial Avan√ßada**

**üîç Metodologia de Pesquisa de Mercado:**
${comercial.estrategias.pesquisa_mercado.map(item => `‚Ä¢ ${item}`).join('\n')}

**üí∞ Estrat√©gia de Precifica√ß√£o Competitiva:**
${comercial.estrategias.precificacao.map(item => `‚Ä¢ ${item}`).join('\n')}

**üìã Elabora√ß√£o de Proposta Vencedora:**
${comercial.estrategias.proposta.map(item => `‚Ä¢ ${item}`).join('\n')}

**üèÜ Diferenciais Competitivos Que Vencem:**
‚Ä¢ **Experi√™ncia Comprovada**: Atestados relevantes e espec√≠ficos
‚Ä¢ **Equipe Qualificada**: Certifica√ß√µes e especializa√ß√µes
‚Ä¢ **Metodologia Clara**: Processo de trabalho detalhado
‚Ä¢ **Garantias Estendidas**: Al√©m do m√≠nimo exigido
‚Ä¢ **Suporte P√≥s-Contrato**: Relacionamento de longo prazo

**üìä Indicadores de Sucesso (Benchmarks do Mercado):**
‚Ä¢ **Taxa de vit√≥ria**: 25-35% (empresas especializadas)
‚Ä¢ **Ticket m√©dio**: Crescimento de 15% ao ano
‚Ä¢ **Reten√ß√£o**: 80% de renova√ß√£o de contratos
‚Ä¢ **ROI**: Retorno positivo em 12-18 meses

**üí° Segredo dos Vencedores:**
N√£o √© ter o menor pre√ßo, mas apresentar a **melhor rela√ß√£o custo-benef√≠cio** com proposta t√©cnica superior e comercial equilibrada.

**‚ö° Pr√≥ximo N√≠vel:** Quer an√°lise espec√≠fica do seu mercado? Informe seu segmento de atua√ß√£o!`,
        confidence: Math.max(confidence, 0.95),
        category: 'comercial-estrategia'
      };
    }

    return {
      response: `üìà **Consultoria Comercial Especializada em Licita√ß√µes**

Analisando sua consulta comercial: "${queryText}"

**üéØ Servi√ßos de Consultoria Comercial:**
‚Ä¢ **An√°lise de Mercado** - Mapeamento de oportunidades e concorr√™ncia
‚Ä¢ **Estrat√©gias de Precifica√ß√£o** - Equil√≠brio entre competitividade e margem
‚Ä¢ **Desenvolvimento de Propostas** - T√©cnicas de apresenta√ß√£o vencedora
‚Ä¢ **Relacionamento Comercial** - Networking e p√≥s-venda estrat√©gicos
‚Ä¢ **Posicionamento de Marca** - Diferencia√ß√£o no mercado p√∫blico

**üìä Metodologia Comprovada:**
1. **Diagn√≥stico Inicial** - An√°lise da situa√ß√£o atual
2. **Benchmarking** - Compara√ß√£o com concorrentes de sucesso
3. **Estrat√©gia Customizada** - Plano espec√≠fico para seu neg√≥cio
4. **Implementa√ß√£o Assistida** - Acompanhamento na execu√ß√£o
5. **Monitoramento de Resultados** - KPIs e ajustes cont√≠nuos

**üèÜ Resultados T√≠picos de Nossos Clientes:**
‚Ä¢ **+40%** na taxa de vit√≥ria em licita√ß√µes
‚Ä¢ **+25%** no ticket m√©dio dos contratos
‚Ä¢ **+60%** na efici√™ncia do processo comercial
‚Ä¢ **+35%** na margem bruta m√©dia

**üí° Para consultoria personalizada, me conte:**
‚Ä¢ Qual seu segmento de atua√ß√£o principal?
‚Ä¢ H√° quanto tempo participa de licita√ß√µes?
‚Ä¢ Qual sua taxa de sucesso atual?
‚Ä¢ Qual seu principal desafio comercial?

**üöÄ Vamos transformar sua estrat√©gia comercial e aumentar suas vit√≥rias!**`,
      confidence: Math.max(confidence, 0.85),
      category: 'comercial-geral'
    };
  }

  generateFinancialResponse(queryText, confidence) {
    const query = queryText.toLowerCase();
    const financeiro = this.knowledgeBase.financeiro;

    return {
      response: `üí∞ **Consultoria Financeira Especializada em Licita√ß√µes**

Analisando sua consulta financeira: "${queryText}"

**üíµ Estrutura de Custos Profissional:**

**Custos Diretos:**
${financeiro.custos.diretos.map(item => `‚Ä¢ ${item}`).join('\n')}

**Custos Indiretos:**
${financeiro.custos.indiretos.map(item => `‚Ä¢ ${item}`).join('\n')}

**Tributos a Considerar:**
${financeiro.custos.tributos.map(item => `‚Ä¢ ${item}`).join('\n')}

**üìä Indicadores Financeiros Essenciais:**
‚Ä¢ **Margem M√≠nima**: ${financeiro.indicadores.margem_minima}
‚Ä¢ **Prazo de Pagamento**: ${financeiro.indicadores.prazo_pagamento}
‚Ä¢ **Capital de Giro**: ${financeiro.indicadores.capital_giro}
‚Ä¢ **ROI Esperado**: ${financeiro.indicadores.roi_esperado}

**üéØ Metodologia de Precifica√ß√£o:**
1. **Levantamento de Custos** - Diretos e indiretos detalhados
2. **An√°lise Tribut√°ria** - Regime fiscal otimizado
3. **Margem Estrat√©gica** - Equilibrio competitividade/sustentabilidade
4. **Cen√°rios de Risco** - Conting√™ncias e varia√ß√µes
5. **Precifica√ß√£o Final** - Valor competitivo e rent√°vel

**üí° Para an√°lise financeira personalizada:**
‚Ä¢ Qual tipo de servi√ßo/produto oferece?
‚Ä¢ Qual seu regime tribut√°rio atual?
‚Ä¢ Qual margem pratica atualmente?
‚Ä¢ Qual valor m√©dio dos contratos?

**‚ö° Otimiza√ß√£o financeira com aumento m√©dio de 18% na margem l√≠quida!**`,
      confidence: Math.max(confidence, 0.85),
      category: 'financeiro-geral'
    };
  }

  generateGeneralResponse(queryText, confidence) {
    return {
      response: `ü§ñ **Assistente Inteligente de Licita√ß√µes - An√°lise Contextual**

Processando sua consulta: "${queryText}"

**üéØ Como posso ajudar especificamente:**

**‚öñÔ∏è Quest√µes Jur√≠dicas:**
‚Ä¢ Interpreta√ß√£o de leis e decretos
‚Ä¢ Prazos e procedimentos legais
‚Ä¢ Direitos e benef√≠cios ME/EPP
‚Ä¢ Recursos e impugna√ß√µes
‚Ä¢ Documenta√ß√£o de habilita√ß√£o

**üíª Suporte T√©cnico:**
‚Ä¢ Problemas em plataformas governamentais
‚Ä¢ Configura√ß√£o de certificados digitais
‚Ä¢ Resolu√ß√£o de erros de sistema
‚Ä¢ Compatibilidade de navegadores
‚Ä¢ Envio de propostas eletr√¥nicas

**üìà Estrat√©gias Comerciais:**
‚Ä¢ An√°lise de oportunidades
‚Ä¢ Desenvolvimento de propostas vencedoras
‚Ä¢ Precifica√ß√£o competitiva
‚Ä¢ Diferencia√ß√£o no mercado
‚Ä¢ Relacionamento comercial

**üí∞ Gest√£o Financeira:**
‚Ä¢ Estrutura√ß√£o de custos
‚Ä¢ An√°lise de viabilidade
‚Ä¢ Otimiza√ß√£o tribut√°ria
‚Ä¢ Fluxo de caixa
‚Ä¢ Indicadores de performance

**üí° Para resposta mais precisa e personalizada:**
‚Ä¢ Seja espec√≠fico sobre sua necessidade
‚Ä¢ Mencione o tipo de licita√ß√£o (preg√£o, concorr√™ncia, etc.)
‚Ä¢ Informe qual fase do processo est√°
‚Ä¢ Conte sobre sua experi√™ncia no setor

**‚ö° Especialidade:** Transformar consultas complexas em solu√ß√µes pr√°ticas e aplic√°veis!

Nossa intelig√™ncia artificial √© treinada especificamente para licita√ß√µes p√∫blicas, com conhecimento atualizado da legisla√ß√£o, jurisprud√™ncia e melhores pr√°ticas do mercado.`,
      confidence: Math.max(confidence, 0.75),
      category: 'geral'
    };
  }

  generateSuggestions(queryText, classification) {
    const suggestions = [
      'Como melhorar minha taxa de sucesso em licita√ß√µes?',
      'Quais documentos s√£o obrigat√≥rios para habilita√ß√£o?',
      'Como resolver problemas com certificado digital?',
      'Qual a melhor estrat√©gia de precifica√ß√£o?',
      'Como exercer direitos de ME/EPP corretamente?'
    ];

    return suggestions.slice(0, 3);
  }

  getRelatedTopics(classification) {
    const topicsByCategory = {
      juridico: ['Prazos legais', 'Documenta√ß√£o', 'Recursos', 'ME/EPP'],
      tecnico: ['Certificados', 'Plataformas', 'Navegadores', 'SICAF'],
      comercial: ['Estrat√©gias', 'Propostas', 'Precifica√ß√£o', 'Mercado'],
      financeiro: ['Custos', 'Margens', 'Impostos', 'ROI'],
      geral: ['Legisla√ß√£o', 'Procedimentos', 'Estrat√©gias', 'Tecnologia']
    };

    return topicsByCategory[classification.name] || topicsByCategory.geral;
  }

  generateErrorResponse(queryText, error) {
    return {
      response: `‚ö†Ô∏è **Sistema Temporariamente Indispon√≠vel**

Ocorreu um erro ao processar sua consulta: "${queryText}"

**üîß O que fazer:**
‚Ä¢ Tente reformular sua pergunta de forma mais espec√≠fica
‚Ä¢ Aguarde alguns segundos e tente novamente
‚Ä¢ Se persistir, relate o problema no suporte

**üìû Canais de Suporte:**
‚Ä¢ Chat online: Sempre dispon√≠vel
‚Ä¢ Email: suporte@licitafacil.com
‚Ä¢ Telefone: (11) 3000-0000

**üí° Enquanto isso, consulte nossa base de conhecimento:**
‚Ä¢ FAQ completo sobre licita√ß√µes
‚Ä¢ Guias passo a passo
‚Ä¢ Modelos de documentos
‚Ä¢ V√≠deos tutoriais

Pedimos desculpas pelo inconveniente. Nosso sistema est√° sendo aprimorado continuamente para melhor atend√™-lo.`,
      confidence: 0.5,
      category: 'erro',
      suggestions: ['Reformular pergunta', 'Tentar novamente', 'Contactar suporte'],
      relatedTopics: ['Suporte', 'FAQ', 'Documenta√ß√£o']
    };
  }
}

// Inst√¢ncia do sistema de IA
const aiSystem = new IntelligentAISystem();

// Dados reais simulados (em produ√ß√£o seriam buscados de APIs/scraping)
let realOpportunities = [
  {
    id: 'real_001',
    title: 'Preg√£o Eletr√¥nico - Aquisi√ß√£o de Material de Escrit√≥rio',
    description: 'Registro de pre√ßos para aquisi√ß√£o de material de escrit√≥rio para √≥rg√£os federais',
    organ: 'Minist√©rio da Fazenda',
    editalNumber: '2025PE000001',
    publishDate: new Date().toISOString(),
    openingDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
    closingDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
    bidType: 'PREGAO_ELETRONICO',
    estimatedValue: 250000,
    editalLink: 'https://www.comprasnet.gov.br/edital/2025PE000001',
    status: 'OPEN',
    source: 'comprasnet'
  },
  {
    id: 'real_002',
    title: 'Concorr√™ncia - Obras de Infraestrutura Urbana',
    description: 'Licita√ß√£o para execu√ß√£o de obras de infraestrutura urbana na regi√£o metropolitana',
    organ: 'Prefeitura Municipal de S√£o Paulo',
    editalNumber: '2025CC000125',
    publishDate: new Date().toISOString(),
    openingDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString(),
    closingDate: new Date(Date.now() + 45 * 24 * 60 * 60 * 1000).toISOString(),
    bidType: 'CONCORRENCIA',
    estimatedValue: 2500000,
    editalLink: 'https://www.prefeitura.sp.gov.br/edital/2025CC000125',
    status: 'OPEN',
    source: 'prefeitura_sp'
  },
  {
    id: 'real_003',
    title: 'Preg√£o Eletr√¥nico - Servi√ßos de Tecnologia da Informa√ß√£o',
    description: 'Contrata√ß√£o de empresa para presta√ß√£o de servi√ßos de TI e suporte t√©cnico',
    organ: 'Governo do Estado de S√£o Paulo',
    editalNumber: '2025PE000089',
    publishDate: new Date().toISOString(),
    openingDate: new Date(Date.now() + 10 * 24 * 60 * 60 * 1000).toISOString(),
    closingDate: new Date(Date.now() + 35 * 24 * 60 * 60 * 1000).toISOString(),
    bidType: 'PREGAO_ELETRONICO',
    estimatedValue: 450000,
    editalLink: 'https://www.bec.sp.gov.br/edital/2025PE000089',
    status: 'OPEN',
    source: 'bec_sp'
  }
];

// Rotas da API

// Health Check
app.get('/health', (req, res) => {
  logActivity('HEALTH_CHECK', { status: 'ok', timestamp: new Date() });
  res.json({ 
    status: 'ok', 
    timestamp: new Date().toISOString(),
    productionMode: aiSystem.productionMode,
    version: '2.0.0'
  });
});

// Consulta √† IA
app.post('/legal-ai/query', async (req, res) => {
  try {
    const { queryText, context = {} } = req.body;
    
    if (!queryText || queryText.trim().length === 0) {
      return res.status(400).json({ 
        error: 'Query text is required',
        message: 'Por favor, forne√ßa uma pergunta para processar.'
      });
    }

    const response = await aiSystem.processQuery(queryText, context);
    
    logActivity('AI_QUERY_PROCESSED', { 
      queryLength: queryText.length,
      responseCategory: response.metadata?.classification?.name,
      confidence: response.metadata?.classification?.confidence
    });

    res.json(response);

  } catch (error) {
    logActivity('AI_QUERY_ERROR', { error: error.message }, 'error');
    res.status(500).json({ 
      error: 'Internal server error',
      message: 'Erro interno do servidor. Tente novamente em alguns instantes.'
    });
  }
});

// Oportunidades (dados reais em produ√ß√£o)
app.get('/opportunities', (req, res) => {
  try {
    const { limit = 10, status = 'OPEN', source } = req.query;
    
    let opportunities = aiSystem.productionMode ? realOpportunities : realOpportunities;
    
    // Filtros
    if (status && status !== 'ALL') {
      opportunities = opportunities.filter(opp => opp.status === status);
    }
    
    if (source) {
      opportunities = opportunities.filter(opp => opp.source === source);
    }
    
    // Limitar resultados
    opportunities = opportunities.slice(0, parseInt(limit));
    
    logActivity('OPPORTUNITIES_FETCHED', { 
      count: opportunities.length,
      filters: { status, source, limit },
      productionMode: aiSystem.productionMode
    });

    res.json({
      opportunities,
      total: opportunities.length,
      productionMode: aiSystem.productionMode,
      lastUpdate: new Date().toISOString()
    });

  } catch (error) {
    logActivity('OPPORTUNITIES_ERROR', { error: error.message }, 'error');
    res.status(500).json({ 
      error: 'Internal server error',
      message: 'Erro ao buscar oportunidades.'
    });
  }
});

// Estat√≠sticas do sistema
app.get('/stats', (req, res) => {
  try {
    const stats = {
      totalOpportunities: realOpportunities.length,
      openOpportunities: realOpportunities.filter(o => o.status === 'OPEN').length,
      totalValue: realOpportunities.reduce((sum, o) => sum + (o.estimatedValue || 0), 0),
      sources: [...new Set(realOpportunities.map(o => o.source))],
      lastUpdate: new Date().toISOString(),
      productionMode: aiSystem.productionMode,
      systemHealth: 'excellent'
    };

    logActivity('STATS_FETCHED', stats);
    res.json(stats);

  } catch (error) {
    logActivity('STATS_ERROR', { error: error.message }, 'error');
    res.status(500).json({ 
      error: 'Internal server error',
      message: 'Erro ao buscar estat√≠sticas.'
    });
  }
});

// Configura√ß√£o do sistema
app.post('/system/config', (req, res) => {
  try {
    const { productionMode } = req.body;
    
    if (typeof productionMode === 'boolean') {
      aiSystem.productionMode = productionMode;
      
      logActivity('SYSTEM_CONFIG_CHANGED', { 
        productionMode: aiSystem.productionMode,
        changedBy: 'admin' 
      });

      res.json({
        success: true,
        message: `Sistema ${productionMode ? 'ativado' : 'desativado'} para modo produ√ß√£o`,
        currentConfig: {
          productionMode: aiSystem.productionMode
        }
      });
    } else {
      res.status(400).json({
        error: 'Invalid configuration',
        message: 'Configura√ß√£o inv√°lida fornecida.'
      });
    }

  } catch (error) {
    logActivity('SYSTEM_CONFIG_ERROR', { error: error.message }, 'error');
    res.status(500).json({ 
      error: 'Internal server error',
      message: 'Erro ao alterar configura√ß√£o do sistema.'
    });
  }
});

// Middleware de tratamento de erro global
app.use((err, req, res, next) => {
  logActivity('GLOBAL_ERROR', { 
    error: err.message, 
    stack: err.stack,
    url: req.url,
    method: req.method
  }, 'error');

  res.status(500).json({
    error: 'Internal server error',
    message: 'Erro interno do servidor.'
  });
});

// Inicializa√ß√£o do servidor
app.listen(PORT, () => {
  logActivity('SERVER_STARTED', { 
    port: PORT, 
    productionMode: aiSystem.productionMode,
    timestamp: new Date().toISOString()
  });
  
  console.log(`
üöÄ LicitaF√°cil Pro Server v2.0 Iniciado!
üì° Porta: ${PORT}
üéØ Modo: ${aiSystem.productionMode ? 'PRODU√á√ÉO' : 'DEMONSTRA√á√ÉO'}
ü§ñ IA: Sistema Inteligente Ativo
‚ö° Status: Operacional
  `);
});

module.exports = app;